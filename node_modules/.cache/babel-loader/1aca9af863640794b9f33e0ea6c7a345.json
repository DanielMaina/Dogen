{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar tslib_1 = require(\"tslib\");\n\nvar PopupWindow_1 = require(\"./PopupWindow\");\n\nvar EventTypes_1 = require(\"../types/EventTypes\");\n\nvar Utils_1 = tslib_1.__importDefault(require(\"../utils/Utils\"));\n\nvar Popup =\n/** @class */\nfunction () {\n  function Popup(url, bearerTokenProvider, options) {\n    this.onPopupMountedQueue = [];\n    this.isPopupMounted = false;\n    this.useOverlay = true;\n    this.useOverlay = options && typeof options.useOverlay !== 'undefined' ? options.useOverlay : true;\n    this.correlationID = '' + Date.now() + Math.random();\n    this.bearerTokenProvider = bearerTokenProvider;\n    this.popupMountedListener = this.createPopupMountedListener(this.correlationID);\n    window.addEventListener('message', this.popupMountedListener);\n    url = Utils_1.default.http().addRequestParams(url, {\n      cid: this.correlationID,\n      webURI: Utils_1.default.urls.connect\n    });\n    this.popupWindow = PopupWindow_1.PopupWindow.openNew(url, {\n      useOverlay: this.useOverlay\n    });\n  }\n\n  Popup.clearPopupIntervals = function () {\n    // Make sure, all intervals are cleared;\n    Popup.popupIntervals.forEach(function (v, i) {\n      clearInterval(Popup.popupIntervals[i]);\n    });\n    Popup.popupIntervals = [];\n  };\n\n  Popup.prototype.isOpen = function () {\n    return this.popupWindow && !this.popupWindow.closed;\n  };\n\n  Popup.prototype.close = function () {\n    if (this.popupMountedListener) {\n      window.removeEventListener('message', this.popupMountedListener);\n    }\n\n    this.popupWindow.close();\n  };\n\n  Popup.prototype.focus = function () {\n    this.popupWindow.focus();\n  };\n\n  Popup.prototype.attachFinishedListener = function (resolve, reject) {\n    var _this = this;\n\n    return function () {\n      Popup.clearPopupIntervals();\n\n      if (_this.finishedListener) {\n        window.removeEventListener('message', _this.finishedListener);\n        delete _this.finishedListener;\n      }\n\n      Popup.popupIntervals.push(_this.createPopupClosedListener(reject));\n      _this.finishedListener = _this.createFinishedListener(resolve, reject);\n      window.addEventListener('message', _this.finishedListener);\n    };\n  };\n\n  Popup.prototype.createPopupMountedListener = function (correlationID) {\n    var _this = this;\n\n    return function (message) {\n      if (Utils_1.default.messages().hasValidOrigin(message) && Utils_1.default.messages().hasCorrectCorrelationID(message, correlationID) && Utils_1.default.messages().isOfType(message, EventTypes_1.EventTypes.POPUP_MOUNTED)) {\n        _this.isPopupMounted = true;\n\n        if (_this.popupMountedListener) {\n          window.removeEventListener('message', _this.popupMountedListener);\n          delete _this.popupMountedListener;\n        }\n\n        _this.processPopupMountedQueue();\n      }\n    };\n  };\n\n  Popup.prototype.createPopupClosedListener = function (reject) {\n    var _this = this;\n\n    return window.setInterval(function () {\n      if (!_this.popupWindow || _this.popupWindow.closed) {\n        Popup.clearPopupIntervals();\n        reject({\n          status: 'ABORTED',\n          errors: []\n        });\n      }\n    }, 100);\n  };\n\n  Popup.prototype.createFinishedListener = function (resolve, reject) {\n    var _this = this;\n\n    return function (message) {\n      if (Utils_1.default.messages().hasValidOrigin(message) && Utils_1.default.messages().isOfType(message, _this.finishedEventType) && Utils_1.default.messages().hasCorrectCorrelationID(message, _this.correlationID)) {\n        // Finished handler will take cre of popup closing\n        Popup.clearPopupIntervals();\n\n        switch (message.data.result.status) {\n          case 'SUCCESS':\n            resolve(message.data && tslib_1.__assign({}, message.data.result));\n            break;\n\n          case 'ABORTED':\n            reject(message.data && tslib_1.__assign({}, message.data.result));\n            break;\n\n          case 'FAILED':\n            reject(message.data && tslib_1.__assign({}, message.data.result));\n            break;\n        }\n      }\n    };\n  };\n  /**\n   * Process onPopupMountedQueue when popup is mounted\n   */\n\n\n  Popup.prototype.processPopupMountedQueue = function () {\n    if (this.isPopupMounted) {\n      var callback = this.onPopupMountedQueue.shift();\n\n      while (callback) {\n        callback();\n        callback = this.onPopupMountedQueue.shift();\n      }\n    }\n  };\n\n  Popup.popupIntervals = [];\n  return Popup;\n}();\n\nexports.default = Popup;","map":{"version":3,"sources":["../../../src/popup/Popup.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar tslib_1 = require(\"tslib\");\nvar PopupWindow_1 = require(\"./PopupWindow\");\nvar EventTypes_1 = require(\"../types/EventTypes\");\nvar Utils_1 = tslib_1.__importDefault(require(\"../utils/Utils\"));\nvar Popup = /** @class */ (function () {\n    function Popup(url, bearerTokenProvider, options) {\n        this.onPopupMountedQueue = [];\n        this.isPopupMounted = false;\n        this.useOverlay = true;\n        this.useOverlay = (options && typeof options.useOverlay !== 'undefined') ? options.useOverlay : true;\n        this.correlationID = '' + Date.now() + Math.random();\n        this.bearerTokenProvider = bearerTokenProvider;\n        this.popupMountedListener = this.createPopupMountedListener(this.correlationID);\n        window.addEventListener('message', this.popupMountedListener);\n        url = Utils_1.default.http().addRequestParams(url, { cid: this.correlationID, webURI: Utils_1.default.urls.connect });\n        this.popupWindow = PopupWindow_1.PopupWindow.openNew(url, { useOverlay: this.useOverlay });\n    }\n    Popup.clearPopupIntervals = function () {\n        // Make sure, all intervals are cleared;\n        Popup.popupIntervals.forEach(function (v, i) {\n            clearInterval(Popup.popupIntervals[i]);\n        });\n        Popup.popupIntervals = [];\n    };\n    Popup.prototype.isOpen = function () {\n        return this.popupWindow && !this.popupWindow.closed;\n    };\n    Popup.prototype.close = function () {\n        if (this.popupMountedListener) {\n            window.removeEventListener('message', this.popupMountedListener);\n        }\n        this.popupWindow.close();\n    };\n    Popup.prototype.focus = function () {\n        this.popupWindow.focus();\n    };\n    Popup.prototype.attachFinishedListener = function (resolve, reject) {\n        var _this = this;\n        return function () {\n            Popup.clearPopupIntervals();\n            if (_this.finishedListener) {\n                window.removeEventListener('message', _this.finishedListener);\n                delete _this.finishedListener;\n            }\n            Popup.popupIntervals.push(_this.createPopupClosedListener(reject));\n            _this.finishedListener = _this.createFinishedListener(resolve, reject);\n            window.addEventListener('message', _this.finishedListener);\n        };\n    };\n    Popup.prototype.createPopupMountedListener = function (correlationID) {\n        var _this = this;\n        return function (message) {\n            if (Utils_1.default.messages().hasValidOrigin(message)\n                && Utils_1.default.messages().hasCorrectCorrelationID(message, correlationID)\n                && Utils_1.default.messages().isOfType(message, EventTypes_1.EventTypes.POPUP_MOUNTED)) {\n                _this.isPopupMounted = true;\n                if (_this.popupMountedListener) {\n                    window.removeEventListener('message', _this.popupMountedListener);\n                    delete _this.popupMountedListener;\n                }\n                _this.processPopupMountedQueue();\n            }\n        };\n    };\n    Popup.prototype.createPopupClosedListener = function (reject) {\n        var _this = this;\n        return window.setInterval(function () {\n            if (!_this.popupWindow || _this.popupWindow.closed) {\n                Popup.clearPopupIntervals();\n                reject({ status: 'ABORTED', errors: [] });\n            }\n        }, 100);\n    };\n    Popup.prototype.createFinishedListener = function (resolve, reject) {\n        var _this = this;\n        return function (message) {\n            if (Utils_1.default.messages().hasValidOrigin(message)\n                && Utils_1.default.messages().isOfType(message, _this.finishedEventType)\n                && Utils_1.default.messages().hasCorrectCorrelationID(message, _this.correlationID)) {\n                // Finished handler will take cre of popup closing\n                Popup.clearPopupIntervals();\n                switch (message.data.result.status) {\n                    case 'SUCCESS':\n                        resolve(message.data && tslib_1.__assign({}, message.data.result));\n                        break;\n                    case 'ABORTED':\n                        reject(message.data && tslib_1.__assign({}, message.data.result));\n                        break;\n                    case 'FAILED':\n                        reject(message.data && tslib_1.__assign({}, message.data.result));\n                        break;\n                }\n            }\n        };\n    };\n    /**\n     * Process onPopupMountedQueue when popup is mounted\n     */\n    Popup.prototype.processPopupMountedQueue = function () {\n        if (this.isPopupMounted) {\n            var callback = this.onPopupMountedQueue.shift();\n            while (callback) {\n                callback();\n                callback = this.onPopupMountedQueue.shift();\n            }\n        }\n    };\n    Popup.popupIntervals = [];\n    return Popup;\n}());\nexports.default = Popup;\n//# sourceMappingURL=Popup.js.map"]},"metadata":{},"sourceType":"script"}